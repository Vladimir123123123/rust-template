using System.Collections;
using System.Collections.Generic;
using Network;
using Network.Visibility;
using UnityEngine;

public abstract class EntityRealm : IEnumerable<BaseNetworkable>, IEnumerable
{
	public HiddenValue<ListDictionary<NetworkableId, BaseNetworkable>> entityList = new HiddenValue<ListDictionary<NetworkableId, BaseNetworkable>>(new ListDictionary<NetworkableId, BaseNetworkable>());

	public int Count => entityList.Get().Count;

	protected abstract Manager visibilityManager { get; }

	public bool Contains(NetworkableId uid)
	{
		return entityList.Get().Contains(uid);
	}

	public BaseNetworkable Find(NetworkableId uid)
	{
		BaseNetworkable val = null;
		if (!entityList.Get().TryGetValue(uid, out val))
		{
			return null;
		}
		return val;
	}

	public void RegisterID(BaseNetworkable ent)
	{
		if (ent.net != null)
		{
			ListDictionary<NetworkableId, BaseNetworkable> listDictionary = entityList.Get();
			if (listDictionary.Contains(ent.net.ID))
			{
				listDictionary[ent.net.ID] = ent;
			}
			else
			{
				listDictionary.Add(ent.net.ID, ent);
			}
		}
	}

	public void UnregisterID(BaseNetworkable ent)
	{
		if (ent.net != null)
		{
			entityList.Get().Remove(ent.net.ID);
		}
	}

	public Group FindGroup(uint uid)
	{
		return visibilityManager?.Get(uid);
	}

	public Group TryFindGroup(uint uid)
	{
		return visibilityManager?.TryGet(uid);
	}

	public void FindInGroup(uint uid, List<BaseNetworkable> list)
	{
		Group group = TryFindGroup(uid);
		if (group == null)
		{
			return;
		}
		int count = group.networkables.Values.Count;
		Networkable[] buffer = group.networkables.Values.Buffer;
		for (int i = 0; i < count; i++)
		{
			Networkable networkable = buffer[i];
			BaseNetworkable baseNetworkable = Find(networkable.ID);
			if (!(baseNetworkable == null) && baseNetworkable.net != null && baseNetworkable.net.group != null)
			{
				if (baseNetworkable.net.group.ID != uid)
				{
					Debug.LogWarning("Group ID mismatch: " + baseNetworkable.ToString());
				}
				else
				{
					list.Add(baseNetworkable);
				}
			}
		}
	}

	public BufferList<BaseNetworkable>.Enumerator GetEnumerator()
	{
		return entityList.Get().Values.GetEnumerator();
	}

	IEnumerator<BaseNetworkable> IEnumerable<BaseNetworkable>.GetEnumerator()
	{
		return GetEnumerator();
	}

	IEnumerator IEnumerable.GetEnumerator()
	{
		return GetEnumerator();
	}

	public void Clear()
	{
		entityList.Get().Clear();
	}
}
