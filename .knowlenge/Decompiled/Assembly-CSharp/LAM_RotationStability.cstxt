using FIMSpace.FProceduralAnimation;
using UnityEngine;

public class LAM_RotationStability : LegsAnimatorControlModuleBase
{
	private LegsAnimator.Variable _powerV;

	private LegsAnimator.Variable _compenV;

	private LegsAnimator.Variable _sideV;

	private LegsAnimator.Variable _forwV;

	public override bool AskForSpineBone => true;

	public override void OnInit(LegsAnimator.LegsAnimatorCustomModuleHelper helper)
	{
		base.OnInit(helper);
		_powerV = helper.RequestVariable("Rotation Power", 0.4f);
		_compenV = helper.RequestVariable("Compensate Spine", 0.5f);
		_sideV = helper.RequestVariable("Side Multiplier", -1f);
		_forwV = helper.RequestVariable("Forward Multiplier", 1f);
	}

	public override void OnPreLateUpdate(LegsAnimator.LegsAnimatorCustomModuleHelper helper)
	{
		float num = _powerV.GetFloat() * base.EffectBlend;
		if (num == 0f)
		{
			return;
		}
		Vector3 zero = Vector3.zero;
		zero += base.LA._Get_Hips_StabilityLocalOffset;
		zero += base.LA._Get_Hips_StabilityLocalAdjustement;
		zero.x /= base.LA.ScaleReferenceNoScale;
		zero.z += zero.y * 0.4f;
		zero.z /= base.LA.ScaleReferenceNoScale;
		zero.x *= 60f;
		zero.z *= 60f;
		Quaternion identity = Quaternion.identity;
		float num2 = 1f / Mathf.Max(0.15f, base.LA.StabilizeCenterOfMass) * 0.5f;
		identity *= Quaternion.AngleAxis(zero.z * num * _forwV.GetFloat() * num2, base.LA.BaseTransform.right);
		identity *= Quaternion.AngleAxis(zero.x * num * _sideV.GetFloat() * num2, base.LA.BaseTransform.forward);
		base.LA._LastHipsRotationOffsetOutsideInfo *= identity;
		for (int i = 0; i < base.LA.HipsHubs.Count; i++)
		{
			base.LA.HipsHubs[i]._LastHipsRotationOffsetOutsideInfo *= identity;
		}
		if (base.LA.SpineBone != null)
		{
			Quaternion b = Quaternion.identity;
			if (base.LA.SpineBone != null)
			{
				b = base.LA.SpineBone.rotation;
			}
			base.LA.Hips.rotation = identity * base.LA.Hips.rotation;
			base.LA.SpineBone.rotation = Quaternion.Lerp(base.LA.SpineBone.rotation, b, _compenV.GetFloat());
		}
		else
		{
			base.LA.Hips.rotation = identity * base.LA.Hips.rotation;
		}
	}
}
