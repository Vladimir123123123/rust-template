using System;
using Facepunch;
using ProtoBuf;
using Rust;
using UnityEngine;

[Serializable]
public class Magazine
{
	[Serializable]
	public struct Definition
	{
		[Tooltip("Set to 0 to not use inbuilt mag")]
		public int builtInSize;

		[InspectorFlags]
		[Tooltip("If using inbuilt mag, will accept these types of ammo")]
		public AmmoTypes ammoTypes;
	}

	public Definition definition;

	public int capacity;

	public int contents;

	[ItemSelector(ItemCategory.All)]
	public ItemDefinition ammoType;

	public bool allowPlayerReloading = true;

	public bool allowAmmoSwitching = true;

	public void ServerInit()
	{
		if (definition.builtInSize > 0)
		{
			capacity = definition.builtInSize;
		}
	}

	public ProtoBuf.Magazine Save()
	{
		ProtoBuf.Magazine magazine = Pool.Get<ProtoBuf.Magazine>();
		if (ammoType == null)
		{
			magazine.capacity = capacity;
			magazine.contents = 0;
			magazine.ammoType = 0;
		}
		else
		{
			magazine.capacity = capacity;
			magazine.contents = contents;
			magazine.ammoType = ammoType.itemid;
		}
		return magazine;
	}

	public void Load(ProtoBuf.Magazine mag)
	{
		contents = mag.contents;
		capacity = mag.capacity;
		ammoType = ItemManager.FindItemDefinition(mag.ammoType);
	}

	public bool CanReload(IAmmoContainer ammoSource)
	{
		if (contents >= capacity)
		{
			return false;
		}
		return ammoSource.HasAmmo(definition.ammoTypes);
	}
}
