using System;
using Oxide.Core;

public class RPC_Server : RPC_Shared
{
	public abstract class Conditional : Attribute
	{
		public virtual string GetArgs()
		{
			return null;
		}
	}

	public class MaxDistance : Conditional
	{
		private float maximumDistance;

		public bool CheckParent { get; set; }

		public MaxDistance(float maxDist)
		{
			maximumDistance = maxDist;
		}

		public override string GetArgs()
		{
			return maximumDistance.ToString("0.00f") + (CheckParent ? ", true" : "");
		}

		public static bool Test(uint id, string debugName, BaseEntity ent, BasePlayer player, float maximumDistance, bool checkParent = false)
		{
			if (ent == null || player == null)
			{
				return false;
			}
			object obj = Interface.CallHook("OnEntityDistanceCheck", ent, player, id, debugName, maximumDistance, checkParent);
			if (obj is bool)
			{
				return (bool)obj;
			}
			bool flag = ent.Distance(player.eyes.position) <= maximumDistance;
			if (checkParent && !flag)
			{
				BaseEntity parentEntity = ent.GetParentEntity();
				flag = parentEntity != null && parentEntity.Distance(player.eyes.position) <= maximumDistance;
			}
			return flag;
		}
	}

	public class IsVisible : Conditional
	{
		private float maximumDistance;

		public IsVisible(float maxDist)
		{
			maximumDistance = maxDist;
		}

		public override string GetArgs()
		{
			return maximumDistance.ToString("0.00f");
		}

		public static bool Test(uint id, string debugName, BaseEntity ent, BasePlayer player, float maximumDistance)
		{
			if (ent == null || player == null)
			{
				return false;
			}
			object obj = Interface.CallHook("OnEntityVisibilityCheck", ent, player, id, debugName, maximumDistance);
			if (obj is bool)
			{
				return (bool)obj;
			}
			if (GamePhysics.LineOfSight(player.eyes.center, player.eyes.position, 1218519041))
			{
				if (!ent.IsVisible(player.eyes.HeadRay(), 1218519041, maximumDistance))
				{
					return ent.IsVisible(player.eyes.position, maximumDistance);
				}
				return true;
			}
			return false;
		}
	}

	public class FromOwner : Conditional
	{
		private bool includeMounted;

		public FromOwner(bool includeMounted = false)
		{
			this.includeMounted = includeMounted;
		}

		public override string GetArgs()
		{
			return includeMounted.ToString().ToLower();
		}

		public static bool Test(uint id, string debugName, BaseEntity ent, BasePlayer player, bool includeMounted)
		{
			if (ent == null || player == null)
			{
				return false;
			}
			if (ent.net == null || player.net == null)
			{
				return false;
			}
			object obj = Interface.CallHook("OnEntityFromOwnerCheck", ent, player, id, debugName, includeMounted);
			if (obj is bool)
			{
				return (bool)obj;
			}
			if (ent.net.ID == player.net.ID)
			{
				return true;
			}
			if (ent.parentEntity.uid != player.net.ID)
			{
				BaseEntity parentEntity = ent.GetParentEntity();
				if (parentEntity != null && parentEntity.parentEntity.uid == player.net.ID)
				{
					return true;
				}
				if (includeMounted)
				{
					BaseMountable baseMountable = ent as BaseMountable;
					if (baseMountable == null)
					{
						baseMountable = ent.parentEntity.Get(serverside: true) as BaseMountable;
					}
					if (baseMountable != null && baseMountable.GetMounted()?.net?.ID == player.net.ID)
					{
						return true;
					}
				}
				return false;
			}
			return true;
		}
	}

	public class IsActiveItem : Conditional
	{
		public static bool Test(uint id, string debugName, BaseEntity ent, BasePlayer player)
		{
			if (ent == null || player == null)
			{
				return false;
			}
			if (ent.net == null || player.net == null)
			{
				return false;
			}
			object obj = Interface.CallHook("OnEntityActiveCheck", ent, player, id, debugName);
			if (obj is bool)
			{
				return (bool)obj;
			}
			if (ent.net.ID == player.net.ID)
			{
				return true;
			}
			if (ent.parentEntity.uid != player.net.ID)
			{
				return false;
			}
			Item activeItem = player.GetActiveItem();
			if (activeItem == null)
			{
				return false;
			}
			if (activeItem.GetHeldEntity() != ent)
			{
				return false;
			}
			return true;
		}
	}

	public class CallsPerSecond : Conditional
	{
		private ulong callsPerSecond;

		public CallsPerSecond(ulong limit)
		{
			callsPerSecond = limit;
		}

		public override string GetArgs()
		{
			return callsPerSecond.ToString();
		}

		public static bool Test(uint id, string debugName, BaseEntity ent, BasePlayer player, ulong callsPerSecond)
		{
			if (ent == null || player == null)
			{
				return false;
			}
			return player.rpcHistory.TryIncrement(id, callsPerSecond);
		}
	}
}
