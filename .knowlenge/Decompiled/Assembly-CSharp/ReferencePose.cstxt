using System;
using System.Collections.Generic;
using UnityEngine;

[Serializable]
public class ReferencePose
{
	[Serializable]
	public class LegPoseReference
	{
		public BonePoseReference UpperLegPose = new BonePoseReference();

		public BonePoseReference LowerLegPose = new BonePoseReference();

		public BonePoseReference AnklePose = new BonePoseReference();

		public BonePoseReference FeetPose = new BonePoseReference();

		public void SaveLegPose(Leg leg, LegsAnimator animator)
		{
			UpperLegPose.SavePose(leg.BoneStart, animator);
			LowerLegPose.SavePose(leg.BoneMid, animator);
			AnklePose.SavePose(leg.BoneEnd, animator);
			FeetPose.SavePose(leg.BoneFeet, animator);
		}

		public void RestoreLegPose(LegsAnimator animator)
		{
			UpperLegPose.RestorePose(animator);
			LowerLegPose.RestorePose(animator);
			AnklePose.RestorePose(animator);
			FeetPose.RestorePose(animator);
		}
	}

	[Serializable]
	public class BonePoseReference
	{
		public Transform SourceTransform;

		public Quaternion RotationInRoot;

		public Vector3 PositionInRoot;

		public void SavePose(Transform transform, LegsAnimator animator)
		{
			if (!(animator == null) && !(transform == null))
			{
				SourceTransform = transform;
				PositionInRoot = animator.BaseTransform.InverseTransformPoint(transform.position);
				RotationInRoot = FEngineering.QToLocal(animator.BaseTransform.rotation, transform.rotation);
			}
		}

		public void RestorePose(LegsAnimator animator)
		{
			if (!(animator == null) && !(SourceTransform == null))
			{
				SourceTransform.position = animator.BaseTransform.TransformPoint(PositionInRoot);
				SourceTransform.rotation = FEngineering.QToWorld(animator.BaseTransform.rotation, RotationInRoot);
			}
		}
	}

	public BonePoseReference MainHipsPose = new BonePoseReference();

	public List<BonePoseReference> HipsPoses = new List<BonePoseReference>();

	public List<LegPoseReference> LegPoses = new List<LegPoseReference>();

	public bool IsSet(LegsAnimator animator)
	{
		if (MainHipsPose.SourceTransform != null && HipsPoses.Count == animator.ExtraHipsHubs.Count)
		{
			return LegPoses.Count == animator.Legs.Count;
		}
		return false;
	}

	public void TweakListsFor(LegsAnimator animator)
	{
		while (HipsPoses.Count > animator.ExtraHipsHubs.Count)
		{
			HipsPoses.RemoveAt(HipsPoses.Count - 1);
		}
		while (HipsPoses.Count < animator.ExtraHipsHubs.Count)
		{
			HipsPoses.Add(new BonePoseReference());
		}
		while (LegPoses.Count > animator.Legs.Count)
		{
			LegPoses.RemoveAt(LegPoses.Count - 1);
		}
		while (LegPoses.Count < animator.Legs.Count)
		{
			LegPoses.Add(new LegPoseReference());
		}
	}

	public void Clear()
	{
		MainHipsPose.SourceTransform = null;
		HipsPoses.Clear();
		LegPoses.Clear();
	}
}
