using UnityEngine;

public class TakeCoverState : BasicAIState
{
	private StateStatus status = StateStatus.Error;

	private BaseEntity coverFromEntity;

	public TakeCoverState()
		: base(AIState.TakeCover)
	{
	}

	public override void StateEnter(BaseAIBrain brain, BaseEntity entity)
	{
		base.StateEnter(brain, entity);
		status = StateStatus.Running;
		if (!StartMovingToCover(entity as HumanNPC))
		{
			status = StateStatus.Error;
		}
	}

	public override void StateLeave(BaseAIBrain brain, BaseEntity entity)
	{
		base.StateLeave(brain, entity);
		brain.Navigator.ClearFacingDirectionOverride();
		ClearCoverPointUsage(entity);
	}

	private void ClearCoverPointUsage(BaseEntity entity)
	{
		AIPoint aIPoint = brain.Events.Memory.AIPoint.Get(4);
		if (aIPoint != null)
		{
			aIPoint.ClearIfUsedBy(entity);
		}
	}

	private bool StartMovingToCover(HumanNPC entity)
	{
		coverFromEntity = brain.Events.Memory.Entity.Get(brain.Events.CurrentInputMemorySlot);
		Vector3 hideFromPosition = (coverFromEntity ? coverFromEntity.transform.position : (entity.transform.position + entity.LastAttackedDir * 30f));
		AIInformationZone informationZone = entity.GetInformationZone(entity.transform.position);
		if (informationZone == null)
		{
			return false;
		}
		float minRange = ((entity.SecondsSinceAttacked < 2f) ? 2f : 0f);
		float bestCoverPointMaxDistance = brain.Navigator.BestCoverPointMaxDistance;
		AICoverPoint bestCoverPoint = informationZone.GetBestCoverPoint(entity.transform.position, hideFromPosition, minRange, bestCoverPointMaxDistance, entity);
		if (bestCoverPoint == null)
		{
			return false;
		}
		Vector3 position = bestCoverPoint.transform.position;
		if (!brain.Navigator.SetDestination(position, BaseNavigator.NavigationSpeed.Normal))
		{
			return false;
		}
		FaceCoverFromEntity();
		brain.Events.Memory.AIPoint.Set(bestCoverPoint, 4);
		bestCoverPoint.SetUsedBy(entity);
		return true;
	}

	public override void DrawGizmos()
	{
		base.DrawGizmos();
	}

	public override StateStatus StateThink(float delta, BaseAIBrain brain, BaseEntity entity)
	{
		base.StateThink(delta, brain, entity);
		FaceCoverFromEntity();
		if (status == StateStatus.Error)
		{
			return status;
		}
		if (brain.Navigator.Moving)
		{
			return StateStatus.Running;
		}
		return StateStatus.Finished;
	}

	private void FaceCoverFromEntity()
	{
		coverFromEntity = brain.Events.Memory.Entity.Get(brain.Events.CurrentInputMemorySlot);
		if (!(coverFromEntity == null))
		{
			brain.Navigator.SetFacingDirectionEntity(coverFromEntity);
		}
	}
}
