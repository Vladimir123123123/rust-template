using System;
using System.Collections.Generic;
using Facepunch.Flexbox;
using TMPro;
using UnityEngine;
using UnityEngine.UI;

public class FlexTransition : MonoBehaviour
{
	public enum TransitionProperty
	{
		PaddingLeft = 0,
		PaddingRight = 1,
		PaddingTop = 2,
		PaddingBottom = 3,
		Gap = 4,
		MinWidth = 5,
		MinHeight = 6,
		MaxWidth = 7,
		MaxHeight = 8,
		ScaleX = 100,
		ScaleY = 101,
		ImageColor = 102,
		TextColor = 103,
		CanvasAlpha = 104,
		RotationZ = 105,
		TransformTranslateX = 200,
		TransformTranslateY = 201,
		TransformScaleX = 202,
		TransformScaleY = 203,
		TransformRotate = 204
	}

	[Serializable]
	public struct Definition
	{
		public TransitionProperty Property;

		public UnityEngine.Object Object;

		public float FromFloat;

		public float ToFloat;

		public Color FromColor;

		public Color ToColor;

		[Min(0f)]
		public float Duration;

		public LeanTweenType Ease;
	}

	public Definition[] Transitions;

	private readonly List<int> _pendingIds = new List<int>();

	private bool _currentState;

	private bool _hasSwitchedState;

	public void Awake()
	{
		if (!_hasSwitchedState)
		{
			SwitchState(enabled: false, animate: false);
		}
	}

	public void SwitchState(bool enabled, bool animate)
	{
		_currentState = enabled;
		_hasSwitchedState = true;
		if (Transitions == null || Transitions.Length == 0)
		{
			return;
		}
		foreach (int pendingId in _pendingIds)
		{
			LeanTween.cancel(pendingId);
		}
		_pendingIds.Clear();
		for (int i = 0; i < Transitions.Length; i++)
		{
			LTDescr lTDescr = RunTransitionImpl(in Transitions[i], animate);
			if (lTDescr != null)
			{
				_pendingIds.Add(lTDescr.uniqueId);
			}
		}
	}

	public void SwitchState(bool enabled)
	{
		SwitchState(enabled, animate: true);
	}

	public void ToggleState()
	{
		SwitchState(!_currentState);
	}

	private LTDescr RunTransitionImpl(in Definition transition, bool animate)
	{
		LTDescr result = null;
		switch (transition.Property)
		{
		case TransitionProperty.ScaleX:
		{
			FlexElement flexElement = transition.Object as FlexElement;
			if (flexElement == null)
			{
				break;
			}
			float num2 = (_currentState ? transition.ToFloat : transition.FromFloat);
			if (animate)
			{
				result = LeanTween.scaleX(flexElement.gameObject, num2, transition.Duration).setEase(transition.Ease).setOnUpdate(delegate(float value, object obj)
				{
					if (obj is FlexElement flexElement2)
					{
						flexElement2.SetLayoutDirty();
					}
				}, flexElement);
			}
			else
			{
				Vector3 localScale = flexElement.transform.localScale;
				localScale.x = num2;
				flexElement.transform.localScale = localScale;
				flexElement.SetLayoutDirty();
			}
			break;
		}
		case TransitionProperty.ScaleY:
		{
			FlexElement flexElement3 = transition.Object as FlexElement;
			if (flexElement3 == null)
			{
				break;
			}
			float num3 = (_currentState ? transition.ToFloat : transition.FromFloat);
			if (animate)
			{
				result = LeanTween.scaleY(flexElement3.gameObject, num3, transition.Duration).setEase(transition.Ease).setOnUpdate(delegate(float value, object obj)
				{
					FlexElement flexElement4 = (FlexElement)obj;
					if (flexElement4 != null)
					{
						flexElement4.SetLayoutDirty();
					}
				}, flexElement3);
			}
			else
			{
				Vector3 localScale2 = flexElement3.transform.localScale;
				localScale2.y = num3;
				flexElement3.transform.localScale = localScale2;
				flexElement3.SetLayoutDirty();
			}
			break;
		}
		case TransitionProperty.ImageColor:
		{
			Image image = transition.Object as Image;
			if (image == null)
			{
				break;
			}
			Color color = image.color;
			Color color2 = (_currentState ? transition.ToColor : transition.FromColor);
			if (animate)
			{
				result = LeanTween.value(image.gameObject, color, color2, transition.Duration).setEase(transition.Ease).setOnUpdateParam(image)
					.setOnUpdateColor(delegate(Color value, object obj)
					{
						if (obj is Image image2)
						{
							image2.color = value;
						}
					});
			}
			else
			{
				image.color = color2;
			}
			break;
		}
		case TransitionProperty.TextColor:
		{
			TMP_Text tMP_Text = transition.Object as TMP_Text;
			if (tMP_Text == null)
			{
				break;
			}
			Color color3 = tMP_Text.color;
			Color color4 = (_currentState ? transition.ToColor : transition.FromColor);
			if (animate)
			{
				result = LeanTween.value(tMP_Text.gameObject, color3, color4, transition.Duration).setEase(transition.Ease).setOnUpdateParam(tMP_Text)
					.setOnUpdateColor(delegate(Color value, object state)
					{
						if (state is TMP_Text tMP_Text2)
						{
							tMP_Text2.color = value;
						}
					});
			}
			else
			{
				tMP_Text.color = color4;
			}
			break;
		}
		case TransitionProperty.CanvasAlpha:
		{
			CanvasGroup canvasGroup = transition.Object as CanvasGroup;
			if (!(canvasGroup == null))
			{
				float num9 = (_currentState ? transition.ToFloat : transition.FromFloat);
				if (animate)
				{
					result = LeanTween.alphaCanvas(canvasGroup, num9, transition.Duration).setEase(transition.Ease);
				}
				else
				{
					canvasGroup.alpha = num9;
				}
			}
			break;
		}
		case TransitionProperty.RotationZ:
		{
			Transform transform = transition.Object as Transform;
			if (!(transform == null))
			{
				float num8 = (_currentState ? transition.ToFloat : transition.FromFloat);
				if (animate)
				{
					result = LeanTween.rotateZ(transform.gameObject, num8, transition.Duration).setEase(transition.Ease);
					break;
				}
				Vector3 localEulerAngles = transform.localEulerAngles;
				localEulerAngles.z = num8;
				transform.localEulerAngles = localEulerAngles;
			}
			break;
		}
		case TransitionProperty.TransformTranslateX:
		{
			FlexGraphicTransform flexGraphicTransform9 = transition.Object as FlexGraphicTransform;
			if (flexGraphicTransform9 == null)
			{
				break;
			}
			float translateX = flexGraphicTransform9.TranslateX;
			float num10 = (_currentState ? transition.ToFloat : transition.FromFloat);
			if (animate)
			{
				result = LeanTween.value(flexGraphicTransform9.gameObject, translateX, num10, transition.Duration).setEase(transition.Ease).setOnUpdateParam(flexGraphicTransform9)
					.setOnUpdateObject(delegate(float value, object state)
					{
						if (state is FlexGraphicTransform flexGraphicTransform10)
						{
							flexGraphicTransform10.TranslateX = value;
							flexGraphicTransform10.SetVerticesDirty();
						}
					});
			}
			else
			{
				flexGraphicTransform9.TranslateX = num10;
				flexGraphicTransform9.SetVerticesDirty();
			}
			break;
		}
		case TransitionProperty.TransformTranslateY:
		{
			FlexGraphicTransform flexGraphicTransform5 = transition.Object as FlexGraphicTransform;
			if (flexGraphicTransform5 == null)
			{
				break;
			}
			float translateY = flexGraphicTransform5.TranslateY;
			float num6 = (_currentState ? transition.ToFloat : transition.FromFloat);
			if (animate)
			{
				result = LeanTween.value(flexGraphicTransform5.gameObject, translateY, num6, transition.Duration).setEase(transition.Ease).setOnUpdateParam(flexGraphicTransform5)
					.setOnUpdateObject(delegate(float value, object state)
					{
						if (state is FlexGraphicTransform flexGraphicTransform6)
						{
							flexGraphicTransform6.TranslateY = value;
							flexGraphicTransform6.SetVerticesDirty();
						}
					});
			}
			else
			{
				flexGraphicTransform5.TranslateY = num6;
				flexGraphicTransform5.SetVerticesDirty();
			}
			break;
		}
		case TransitionProperty.TransformScaleX:
		{
			FlexGraphicTransform flexGraphicTransform = transition.Object as FlexGraphicTransform;
			if (flexGraphicTransform == null)
			{
				break;
			}
			float scaleX = flexGraphicTransform.ScaleX;
			float num4 = (_currentState ? transition.ToFloat : transition.FromFloat);
			if (animate)
			{
				result = LeanTween.value(flexGraphicTransform.gameObject, scaleX, num4, transition.Duration).setEase(transition.Ease).setOnUpdateParam(flexGraphicTransform)
					.setOnUpdateObject(delegate(float value, object state)
					{
						if (state is FlexGraphicTransform flexGraphicTransform2)
						{
							flexGraphicTransform2.ScaleX = value;
							flexGraphicTransform2.SetVerticesDirty();
						}
					});
			}
			else
			{
				flexGraphicTransform.ScaleX = num4;
				flexGraphicTransform.SetVerticesDirty();
			}
			break;
		}
		case TransitionProperty.TransformScaleY:
		{
			FlexGraphicTransform flexGraphicTransform3 = transition.Object as FlexGraphicTransform;
			if (flexGraphicTransform3 == null)
			{
				break;
			}
			float scaleY = flexGraphicTransform3.ScaleY;
			float num5 = (_currentState ? transition.ToFloat : transition.FromFloat);
			if (animate)
			{
				result = LeanTween.value(flexGraphicTransform3.gameObject, scaleY, num5, transition.Duration).setEase(transition.Ease).setOnUpdateParam(flexGraphicTransform3)
					.setOnUpdateObject(delegate(float value, object state)
					{
						if (state is FlexGraphicTransform flexGraphicTransform4)
						{
							flexGraphicTransform4.ScaleY = value;
							flexGraphicTransform4.SetVerticesDirty();
						}
					});
			}
			else
			{
				flexGraphicTransform3.ScaleY = num5;
				flexGraphicTransform3.SetVerticesDirty();
			}
			break;
		}
		case TransitionProperty.TransformRotate:
		{
			FlexGraphicTransform flexGraphicTransform7 = transition.Object as FlexGraphicTransform;
			if (flexGraphicTransform7 == null)
			{
				break;
			}
			float rotate = flexGraphicTransform7.Rotate;
			float num7 = (_currentState ? transition.ToFloat : transition.FromFloat);
			if (animate)
			{
				result = LeanTween.value(flexGraphicTransform7.gameObject, rotate, num7, transition.Duration).setEase(transition.Ease).setOnUpdateParam(flexGraphicTransform7)
					.setOnUpdateObject(delegate(float value, object state)
					{
						if (state is FlexGraphicTransform flexGraphicTransform8)
						{
							flexGraphicTransform8.Rotate = value;
							flexGraphicTransform8.SetVerticesDirty();
						}
					});
			}
			else
			{
				flexGraphicTransform7.Rotate = num7;
				flexGraphicTransform7.SetVerticesDirty();
			}
			break;
		}
		default:
		{
			FlexElement element = transition.Object as FlexElement;
			if (element == null)
			{
				break;
			}
			TransitionProperty property = transition.Property;
			float num = (_currentState ? transition.ToFloat : transition.FromFloat);
			if (animate)
			{
				result = LeanTween.value(element.gameObject, Property(element, property), num, transition.Duration).setEase(transition.Ease).setOnUpdate(delegate(float newValue, object _)
				{
					if (element != null)
					{
						Property(element, property) = newValue;
						element.SetLayoutDirty();
					}
				}, this);
			}
			else
			{
				Property(element, property) = num;
				element.SetLayoutDirty();
			}
			break;
		}
		}
		return result;
	}

	private static ref float Property(FlexElement element, TransitionProperty property)
	{
		return property switch
		{
			TransitionProperty.PaddingLeft => ref element.Padding.left, 
			TransitionProperty.PaddingRight => ref element.Padding.right, 
			TransitionProperty.PaddingTop => ref element.Padding.top, 
			TransitionProperty.PaddingBottom => ref element.Padding.bottom, 
			TransitionProperty.Gap => ref element.Gap, 
			TransitionProperty.MinWidth => ref element.MinWidth.Value, 
			TransitionProperty.MinHeight => ref element.MinHeight.Value, 
			TransitionProperty.MaxWidth => ref element.MaxWidth.Value, 
			TransitionProperty.MaxHeight => ref element.MaxHeight.Value, 
			_ => throw new NotSupportedException(string.Format("{0} {1}", "TransitionProperty", property)), 
		};
	}
}
