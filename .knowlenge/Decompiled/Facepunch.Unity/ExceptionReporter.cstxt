using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Text;
using Facepunch;
using Facepunch.Extend;
using Facepunch.Math;
using Newtonsoft.Json;
using Rust;
using UnityEngine;
using UnityEngine.SceneManagement;

public class ExceptionReporter : MonoBehaviour
{
	private static readonly Stopwatch LastReportTime = Stopwatch.StartNew();

	private static int _reportsSentCounter;

	public static bool Disabled { get; set; }

	public static string PublicKey { get; private set; }

	public static string SecretKey { get; private set; }

	public static string Host { get; private set; }

	public static string ProjectId { get; private set; }

	public static int ReportMessageMaxLength { get; set; }

	private static Dictionary<string, string> Headers
	{
		get
		{
			string text = Epoch.Current.ToString();
			Dictionary<string, string> dictionary = new Dictionary<string, string>();
			dictionary.Add("X-Sentry-Auth", "Sentry sentry_version=5, sentry_client=FacepunchER/1.0, sentry_timestamp=" + text + ", sentry_key=" + PublicKey + ", sentry_secret=" + SecretKey);
			return dictionary;
		}
	}

	internal static void InstallHooks()
	{
		UnityEngine.Application.logMessageReceived += OnLogMessage;
	}

	private static void OnLogMessage(string message, string stackTrace, LogType type)
	{
		if (Disabled || !Facepunch.Application.Integration.ShouldReportException(message, stackTrace, type))
		{
			return;
		}
		if (LastReportTime.Elapsed.TotalSeconds > 60.0)
		{
			LastReportTime.Reset();
			LastReportTime.Start();
			_reportsSentCounter = 0;
		}
		if (_reportsSentCounter >= 5)
		{
			return;
		}
		LastReportTime.Reset();
		LastReportTime.Start();
		_reportsSentCounter++;
		if (type == LogType.Exception)
		{
			if (message.Contains("NullReferenceException"))
			{
				string[] array = stackTrace.Split('\n');
				message = message + ": " + array[0];
			}
			if (message.Contains("IndexOutOfRangeException"))
			{
				string[] array2 = stackTrace.Split('\n');
				message = message + ": " + array2[0];
			}
			if (message.Contains("ArgumentOutOfRangeException"))
			{
				string[] array3 = stackTrace.Split('\n');
				message = message + ": " + array3[0];
			}
		}
		SendReport(message, stackTrace, type);
	}

	public static void InitializeFromUrl(string url)
	{
		string[] array = url.Replace("https://", "").Split('/', ':', '@');
		PublicKey = array[0];
		SecretKey = array[1];
		Host = array[2];
		ProjectId = array[3];
	}

	public static void SendReport(string exception, string stacktrace, LogType logType)
	{
		if (!string.IsNullOrEmpty(Host) && !string.IsNullOrEmpty(ProjectId) && !string.IsNullOrEmpty(PublicKey) && !string.IsNullOrEmpty(SecretKey))
		{
			Report report = new Report();
			report.release = BuildInfo.Current.Scm.Branch.Replace("/", "-") + "#" + BuildInfo.Current.Scm.ChangeId;
			report.message = exception.Truncate(ReportMessageMaxLength, "");
			report.platform = "csharp";
			report.event_id = Guid.NewGuid().ToString("N");
			report.stacktrace = new Report.StackTrace(stacktrace);
			report.user = new Report.User();
			report.tags = new Dictionary<string, string>();
			report.tags.Add("memory", Mathf.RoundToInt(SystemInfo.systemMemorySize / 1024) + "gb");
			report.tags.Add("operatingSystem", SystemInfo.operatingSystem);
			report.tags.Add("batteryStatus", SystemInfo.batteryStatus.ToString());
			report.tags.Add("deviceModel", SystemInfo.deviceModel);
			report.tags.Add("processorType", SystemInfo.processorType);
			report.tags.Add("graphicsDeviceName", SystemInfo.graphicsDeviceName);
			report.tags.Add("graphicsMemorySize", Mathf.RoundToInt(SystemInfo.graphicsMemorySize / 1024) + "gb");
			report.tags.Add("architecture", (IntPtr.Size == 4) ? "x86" : "x64");
			report.tags.Add("scene", SceneManager.GetSceneAt(0).name);
			report.tags.Add("qualitylevel", QualitySettings.GetQualityLevel().ToString());
			report.tags.Add("level", logType.ToString().ToLower());
			if (Rust.Application.isQuitting)
			{
				report.tags.Add("quitting", "true");
			}
			report.tags.Add("realm", "SERVER");
			string s = JsonConvert.SerializeObject((object)report);
			new WWW("https://" + Host + "/api/" + ProjectId + "/store/", Encoding.ASCII.GetBytes(s), Headers);
		}
	}
}
