using System;
using System.Collections.Generic;
using System.Net;
using System.Net.Sockets;
using Facepunch;

public readonly struct ServerInfo
{
	public enum Protocol
	{
		Default,
		Raknet,
		Steamworks
	}

	private static readonly HashSet<StringView> EmptyTags = new HashSet<StringView>();

	public uint AppId { get; }

	public string Name { get; }

	public IPAddress Address { get; }

	public uint AddressRaw { get; }

	public int ConnectionPort { get; }

	public int QueryPort { get; }

	public string Map { get; }

	public string TagString { get; }

	public bool IsSecure { get; }

	public int Players { get; }

	public int MaxPlayers { get; }

	public uint LastTimePlayed { get; }

	public int Ping { get; }

	public ulong SteamId { get; }

	public StringView RegionCode { get; }

	public uint Born { get; }

	public HashSet<StringView> Tags { get; }

	public bool HasPremiumTag => false;

	public Protocol ConnectionProtocol { get; }

	public string ConnectionString => $"{Address}:{ConnectionPort}";

	public ServerInfo(uint appId, string name, IPAddress address, int connectionPort, int queryPort, string map, string tagString, bool isSecure, int players, int maxPlayers, uint lastTimePlayed, int ping, ulong steamId, int authedPlayers = int.MaxValue)
	{
		AppId = appId;
		Name = name;
		Address = address ?? throw new ArgumentNullException("address");
		AddressRaw = AddressToUInt32(address);
		ConnectionPort = connectionPort;
		QueryPort = queryPort;
		Map = map;
		TagString = tagString;
		IsSecure = isSecure;
		RegionCode = default(StringView);
		if (!string.IsNullOrEmpty(TagString))
		{
			List<StringView> obj = Pool.Get<List<StringView>>();
			((StringView)TagString).Split(',', obj);
			Tags = new HashSet<StringView>(obj, StringView.ComparerIgnoreCase.Instance);
			Pool.FreeUnmanaged(ref obj);
		}
		else
		{
			Tags = EmptyTags;
		}
		ConnectionProtocol = Protocol.Default;
		uint result = 0u;
		foreach (StringView tag in Tags)
		{
			if (tag.StartsWith("cp"))
			{
				int.TryParse(tag.Substring(2), out players);
			}
			else if (tag.StartsWith("mp"))
			{
				int.TryParse(tag.Substring(2), out maxPlayers);
			}
			else if (tag.StartsWith("pt"))
			{
				StringView stringView = tag.Substring(2);
				if (stringView == "sw")
				{
					ConnectionProtocol = Protocol.Steamworks;
				}
				else if (stringView == "rak")
				{
					ConnectionProtocol = Protocol.Raknet;
				}
			}
			else if (tag.StartsWith("$r"))
			{
				RegionCode = tag.Substring(2);
			}
			else if (tag.StartsWith("born"))
			{
				uint.TryParse(tag.Substring(4), out result);
			}
		}
		Players = Math.Min(players, authedPlayers);
		MaxPlayers = maxPlayers;
		LastTimePlayed = lastTimePlayed;
		Ping = ping;
		SteamId = steamId;
		Born = result;
	}

	private static uint AddressToUInt32(IPAddress address)
	{
		if (address.AddressFamily != AddressFamily.InterNetwork)
		{
			return 0u;
		}
		return Swap((uint)address.Address);
	}

	private static uint Swap(uint x)
	{
		return ((x & 0xFF) << 24) + ((x & 0xFF00) << 8) + ((x & 0xFF0000) >> 8) + ((x & 0xFF000000u) >> 24);
	}
}
