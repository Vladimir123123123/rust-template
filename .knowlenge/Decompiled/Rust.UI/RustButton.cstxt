using Rust.UI;
using UnityEngine;
using UnityEngine.Events;
using UnityEngine.EventSystems;
using UnityEngine.UI;

[AddComponentMenu("Rust/UI/Button")]
public class RustButton : RustControl, IPointerDownHandler, IEventSystemHandler, IPointerUpHandler, ILayoutElement
{
	public Image Background;

	public RustText Text;

	public RustText SubText;

	public RustIcon Icon;

	public Image IconImage;

	public UnityEvent OnPressed;

	public UnityEvent OnReleased;

	public bool IsToggle;

	public bool UnpressSiblings;

	public bool PreventToggleOff;

	public Transform TabPanelTarget;

	public Vector4 TextMargin = new Vector4(30f, 5f, 10f, 5f);

	public Vector4 TextMarginNoIcon = new Vector4(10f, 5f, 10f, 5f);

	public bool Value
	{
		get
		{
			return IsPressed;
		}
		set
		{
			if (value != Value)
			{
				if (value)
				{
					CurrentState |= State.Pressed;
				}
				else
				{
					CurrentState &= ~State.Pressed;
				}
				ApplyStyles();
			}
		}
	}

	public bool AutoSize
	{
		get
		{
			return Text.AutoSizeParent;
		}
		set
		{
			Text.AutoSizeParent = value;
		}
	}

	public float minWidth
	{
		get
		{
			if (!Text)
			{
				return 0f;
			}
			return Text.rectTransform.rect.width;
		}
	}

	public float preferredWidth
	{
		get
		{
			if (!Text)
			{
				return 0f;
			}
			return Text.rectTransform.rect.width;
		}
	}

	public float flexibleWidth
	{
		get
		{
			if (!Text)
			{
				return 0f;
			}
			return Text.rectTransform.rect.width;
		}
	}

	public float minHeight
	{
		get
		{
			if (!Text)
			{
				return 0f;
			}
			return Text.minHeight;
		}
	}

	public float preferredHeight
	{
		get
		{
			if (!Text)
			{
				return 0f;
			}
			return Text.preferredHeight;
		}
	}

	public float flexibleHeight
	{
		get
		{
			if (!Text)
			{
				return 0f;
			}
			return Text.flexibleHeight;
		}
	}

	public int layoutPriority
	{
		get
		{
			if (!Text)
			{
				return 0;
			}
			return Text.layoutPriority;
		}
	}

	public void Press()
	{
		if (IsDisabled)
		{
			return;
		}
		if (IsToggle)
		{
			if (!PreventToggleOff || !Value)
			{
				Toggle(!Value);
			}
		}
		else
		{
			Toggle(v: true, forced: true);
		}
	}

	public void Unpress()
	{
		if (!IsDisabled)
		{
			if (!IsToggle)
			{
				Toggle(v: false, forced: true);
			}
			ApplyStyles();
		}
	}

	public virtual void OnPointerDown(PointerEventData eventData)
	{
		if (eventData.button == PointerEventData.InputButton.Left)
		{
			Press();
		}
	}

	public void SetToggleTrue()
	{
		Toggle(v: true);
	}

	public void SetToggleFalse()
	{
		Toggle(v: false);
	}

	public void Toggle(bool v, bool forced = false)
	{
		if (v)
		{
			if (UnpressSiblings)
			{
				DoUnpressSiblings();
			}
			if (Value && !forced)
			{
				return;
			}
			CurrentState |= State.Pressed;
			OnPressed.Invoke();
			ToggleTabPanel(onOff: true);
		}
		else
		{
			if (!Value && !forced)
			{
				return;
			}
			CurrentState &= ~State.Pressed;
			OnReleased.Invoke();
			ToggleTabPanel(onOff: false);
		}
		ApplyStyles();
	}

	private void ToggleTabPanel(bool onOff)
	{
		if (!(TabPanelTarget == null))
		{
			Transform transform = TabPanelTarget.Find(base.gameObject.name);
			if (!(transform == null))
			{
				transform.gameObject.SetActive(onOff);
			}
		}
	}

	private void DoUnpressSiblings()
	{
		foreach (Transform item in base.transform.parent)
		{
			if (!(item == base.transform))
			{
				RustButton component = item.GetComponent<RustButton>();
				if (!(component == null))
				{
					component.Toggle(v: false);
				}
			}
		}
	}

	public virtual void OnPointerUp(PointerEventData eventData)
	{
		Unpress();
	}

	protected override void OnDisable()
	{
		base.OnDisable();
		if (!IsToggle && Value)
		{
			CurrentState &= ~State.Pressed;
			ApplyStyles();
		}
		if (!IsToggle && CurrentState.HasFlag(State.Hovered))
		{
			CurrentState &= ~State.Hovered;
			ApplyStyles();
		}
	}

	protected override void ApplyStyle(StyleColorSet s)
	{
		if ((bool)Background)
		{
			Background.color = s.Bg;
		}
		if ((bool)Text)
		{
			Text.color = s.Fg;
		}
		if ((bool)SubText)
		{
			SubText.color = Color.Lerp(s.Bg, s.Fg, 0.5f);
		}
		if ((bool)Icon)
		{
			Icon.color = s.Icon;
		}
		if ((bool)IconImage)
		{
			IconImage.color = s.Icon;
		}
		if ((bool)Text)
		{
			Vector4 vector = (((!Icon || Icon.Icon == Icons.None) && !IconImage) ? TextMarginNoIcon : TextMargin);
			if (Text.margin != vector)
			{
				Text.margin = vector;
				Text.DoAutoSize();
			}
			if (SubText != null && SubText.margin != vector)
			{
				SubText.margin = vector;
				SubText.DoAutoSize();
			}
		}
	}

	public void CalculateLayoutInputHorizontal()
	{
		Text?.CalculateLayoutInputHorizontal();
	}

	public void CalculateLayoutInputVertical()
	{
		Text?.CalculateLayoutInputVertical();
	}
}
