using Rust.UI;
using UnityEngine;
using UnityEngine.UI;
using UnityEngine.Video;

public class Video : RustControl
{
	public RawImage VideoCanvas;

	public VideoPlayer VideoPlayer;

	public CanvasGroup CanvasGroup;

	[Range(0f, 5f)]
	public float FadeIn;

	private uint textureWidth;

	private uint textureHeight;

	private Vector2 playerSize;

	protected override void Awake()
	{
		base.Awake();
		VideoPlayer.errorReceived += VideoPlayer_errorReceived;
	}

	private void VideoPlayer_errorReceived(VideoPlayer source, string message)
	{
		Debug.Log("Video Error: \"" + message + "\"");
	}

	public void PlayUrl(string video)
	{
		VideoPlayer.Stop();
		VideoPlayer.url = video;
		VideoPlayer.Play();
		CanvasGroup.alpha = 0f;
		textureWidth = 0u;
		textureHeight = 0u;
	}

	public void LateUpdate()
	{
		if (VideoPlayer.texture == null)
		{
			CanvasGroup.alpha = 0f;
			textureWidth = 0u;
			textureHeight = 0u;
			VideoCanvas.texture = null;
		}
		else if ((textureWidth != VideoPlayer.width || textureHeight != VideoPlayer.height || !(playerSize == base.rectTransform.GetSize())) && VideoPlayer.isPrepared && VideoPlayer.frame >= 0)
		{
			VideoCanvas.texture = VideoPlayer.texture;
			textureWidth = VideoPlayer.width;
			textureHeight = VideoPlayer.height;
			Cover();
			if (FadeIn > 0f)
			{
				CanvasGroup.alpha = 0f;
				LeanTween.alphaCanvas(CanvasGroup, 1f, FadeIn);
			}
			else
			{
				CanvasGroup.alpha = 1f;
			}
		}
	}

	private void Cover()
	{
		RectTransform trans = VideoCanvas.transform as RectTransform;
		Vector2 size = base.rectTransform.GetSize();
		Vector2 vector = new Vector2(VideoPlayer.width, VideoPlayer.height);
		float num = size.x / size.y;
		float num2 = vector.x / vector.y;
		playerSize = size;
		if (num == num2)
		{
			trans.SetSize(new Vector2(size.x, size.y));
		}
		if (num > num2)
		{
			trans.SetSize(new Vector2(size.x, size.x / num2));
		}
		if (num < num2)
		{
			trans.SetSize(new Vector2(size.y * num2, size.y));
		}
	}

	public void Stop()
	{
		VideoPlayer.Stop();
		VideoCanvas.texture = null;
		textureWidth = 0u;
		textureHeight = 0u;
		CanvasGroup.alpha = 0f;
	}
}
