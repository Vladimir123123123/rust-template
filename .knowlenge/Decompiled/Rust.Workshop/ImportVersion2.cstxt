using System.Collections;
using System.IO;
using Facepunch.Utility;
using Rust;
using Rust.Workshop;
using Rust.Workshop.Import;
using UnityEngine;

internal class ImportVersion2 : SingletonComponent<ImportVersion2>
{
	private AssetBundle Bundle;

	public void OnDisable()
	{
		if (!Rust.Application.isQuitting && Bundle != null)
		{
			Bundle.Unload(unloadAllLoadedObjects: true);
			Bundle = null;
			Debug.Log("CLEANUP BUNDLE");
		}
	}

	internal IEnumerator DoImport(IWorkshopContent item, Skin skin)
	{
		if (Bundle != null)
		{
			Bundle.Unload(unloadAllLoadedObjects: true);
			Bundle = null;
		}
		WorkshopItemEditor.Loading(v1: true, "Downloading..", "", 0f);
		if (!item.IsInstalled)
		{
			item.Download();
			while (item.IsDownloading)
			{
				yield return null;
			}
			while (!item.IsInstalled)
			{
				yield return null;
			}
		}
		string text = item.Directory + "/bundle";
		if (File.Exists(text))
		{
			yield return StartCoroutine(LoadItem(item.Directory, text, skin));
			yield break;
		}
		Debug.LogWarning("No Bundle Found!");
		Os.OpenFolder(item.Directory);
		yield return new WaitForSeconds(5f);
	}

	public IEnumerator LoadItem(string Folder, string BundleName, Skin skin)
	{
		AssetBundleCreateRequest request = AssetBundle.LoadFromFileAsync(BundleName);
		yield return new WaitUntil(() => request.isDone);
		if (request.assetBundle == null)
		{
			Debug.LogWarning("Asset bundle is null!");
			yield break;
		}
		Bundle = request.assetBundle;
		WorkshopSkinBase asset = request.assetBundle.LoadAsset<WorkshopSkinBase>("Meta.asset");
		if (asset == null)
		{
			string[] allAssetNames = request.assetBundle.GetAllAssetNames();
			foreach (string text in allAssetNames)
			{
				asset = request.assetBundle.LoadAsset<WorkshopSkinBase>(text);
				if (asset != null)
				{
					break;
				}
			}
		}
		if (asset == null)
		{
			Os.OpenFolder(Folder);
			yield return new WaitForSeconds(5f);
			yield break;
		}
		yield return StartCoroutine(ProcessMaterial(0, asset.skinMaterial0, skin));
		yield return StartCoroutine(ProcessMaterial(1, asset.skinMaterial1, skin));
		yield return StartCoroutine(ProcessMaterial(2, asset.skinMaterial2, skin));
		yield return StartCoroutine(ProcessMaterial(3, asset.skinMaterial3, skin));
	}

	private IEnumerator ProcessMaterial(int v, Material inputMaterial, Skin skin)
	{
		if (inputMaterial == null || skin.Materials.Length <= v)
		{
			yield break;
		}
		yield return null;
		ImportTexture("_MainTex", inputMaterial, skin.Materials[v], normal: false, skin, v);
		ImportTexture("_BumpMap", inputMaterial, skin.Materials[v], normal: true, skin, v);
		ImportTexture("_OcclusionMap", inputMaterial, skin.Materials[v], normal: false, skin, v);
		if (ImportTexture("_SpecGlossMap", inputMaterial, skin.Materials[v], normal: false, skin, v) == null)
		{
			Texture2D texture2D = ImportTexture("_MetallicGlossMap", inputMaterial, skin.Materials[v], normal: false, skin, v, "_SpecGlossMap");
			if (texture2D != null)
			{
				ConvertMetalToSpec(texture2D, skin.Materials[v]);
			}
		}
	}

	private Texture2D ImportTexture(string name, Material inputMaterial, Material outputMaterial, bool normal, Skin skin, int group, string targetName = null)
	{
		if (targetName == null)
		{
			targetName = name;
		}
		UnityEngine.Texture texture = outputMaterial.GetTexture(name);
		UnityEngine.Texture texture2 = inputMaterial.GetTexture(name);
		if (texture2 == null)
		{
			return null;
		}
		if (texture == null || texture2.name == texture.name)
		{
			return null;
		}
		texture2 = Facepunch.Utility.Texture.LimitSize(texture2 as Texture2D, skin.Skinnable.Groups[group].MaxTextureSize, skin.Skinnable.Groups[group].MaxTextureSize);
		outputMaterial.SetTexture(targetName, texture2);
		return texture2 as Texture2D;
	}

	private Texture2D ConvertMetalToSpec(Texture2D tex, Material outputMaterial)
	{
		tex = Facepunch.Utility.Texture.CreateReadableCopy(tex);
		for (int i = 0; i < tex.height; i++)
		{
			for (int j = 0; j < tex.width; j++)
			{
				Color pixel = tex.GetPixel(j, i);
				if (pixel.a == 0f)
				{
					pixel.a = 0.007843138f;
				}
				Color color = new Color(pixel.r, pixel.r, pixel.r, pixel.a);
				tex.SetPixel(j, i, color);
			}
		}
		tex.Apply();
		outputMaterial.SetTexture("_SpecGlossMap", tex);
		outputMaterial.SetFloat("_Glossiness", 1f);
		outputMaterial.SetColor("_SpecColor", Color.white);
		return tex;
	}
}
